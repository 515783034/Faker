{% extends "base.html" %}

<!-- body content -->
{% block content %}
    <center class="title">{{ url_info["state"] }} mock 数据</center>

    <!-- 设置接口名称 -->
    <el-row type="flex" justify="start" style="margin-top: 15px;">
    <el-col :span="5"></el-col>

    <el-col :span="12">
        <el-input placeholder="输入接口名称" v-model="desc">
            <template slot="prepend">接口名称</template>
        </el-input>
    </el-col>

    <el-col v-if="desc && url && selectMethod" :span="3" :offset='1'>
        <el-button style="margin-left: 30px;" type="warning" round @click="handleAddRequest">{{ url_info["state"] }}接口</el-button>
    </el-col>

    </el-row>

    <!-- 设置接口名称 -->
    <el-row type="flex" justify="start" style="margin-top: 15px;">
    <el-col :span="5"></el-col>
    <el-col :span="12">
        <el-input placeholder="路径" v-model="url">
            <el-select slot="prepend" v-model="selectTitle" placeholder="请选择分类" @change="selectSection">
                <el-tooltip v-for="item in sections" :key="item.value" effect="dark" :content='item.baseUrl' placement="top-start" :open-delay=600>
                    <el-option :label="item.name" :value="item.baseUrl"></el-option>
                </el-tooltip>
            </el-select>
        </el-input>
    </el-col>

    <el-col :span="5" :offset='1'>
        <el-select v-model="selectMethod" placeholder="选择方法" @change="methodChanged">
            <el-option v-for="method in methods" :key="method" :label="method" :value="method"></el-option>
        </el-select>
    </el-col>
    </el-row>

    <!-- 设置接口参数 -->
    <el-row type="flex" justify="start" style="margin-top: 15px;">
    <el-col :span="5"></el-col>
    <el-col :span="4">
        <el-input placeholder="参数名（可选）" v-model="paramName">
            <el-select slot="prepend" v-model="selectParamType" placeholder="参数类型(可选)" @change="paramTypeChanged">
                <el-option v-for="type in paramTypes" :key="type.value" :label="type" :value="type"></el-option>
            </el-select>
        </el-input>
    </el-col>

    <el-col :span="12" style="margin-left: 20px;">
        <el-tag :key="tag" v-for="tag in paramValues" closable :disable-transitions="false" @close="handleClose(tag)">{{tag}}</el-tag>
        <el-input style="width: 115px;margin-left: 10px;vertical-align: bottom;margin-top: 5px;" 
        placeholder="参数值" v-if="inputVisible" v-model="inputValue" ref="saveTagInput" size="small"
            @keyup.enter.native="handleInputConfirm"
            @blur="handleInputConfirm">
        </el-input>
        <el-button v-else v-show="paramName" style="margin-top: 5px;" class="button-new-tag" size="small" @click="showInput">+</el-button>
    </el-col>
    </el-row>

    <el-divider></el-divider>

    <el-row type="flex" justify="center" style="margin-top: 15px;">
    <el-col :span="18">
        <el-tabs v-if="paramValues.length>0" v-model="selectParamValue" type="card">
            <el-tab-pane v-for="(item, index) in paramValues" :key="item" :label="item" :name="item">
                <el-input type="textarea" rows=27 placeholder="请输入接口待返回的json字符串" v-model="paramJson[index]"></el-input>
            </el-tab-pane>
        </el-tabs>
        <el-input v-else type="textarea" rows=27 placeholder="请输入接口待返回的json字符串" v-model="content"></el-input>
    </el-col>

    </el-row>

    <el-backtop></el-backtop>


{% endblock %}

<!-- script -->
{% block script %}
<script>
    result = {{ url_info | tojson }};
    $SCRIPT_ROOT = {{ request.script_root | tojson | safe }};

    var app = new Vue({
        el: '#app',
        data() {
            return {
                isNew: result["isNew"],
                url: result["urlInfo"]["fullUrl"],
                desc: result["urlInfo"]["desc"],
                content: result["urlInfo"]["content"],
                methods: result["methods"],
                selectMethod: result["urlInfo"]["method"],
                sections: result["sections"],
                selectTitle: result["selectTitle"],
                paramName: result["urlInfo"]["param"],
                paramValues: result["urlInfo"]["param_values"] || [],
                paramJson: result["urlInfo"]["param_jsons"] || [],
                selectParamValue: result["urlInfo"]["selectParamValue"],
                paramTypes: result["paramTypes"],
                selectParamType: result["urlInfo"]["paramType"] || "",
                inputVisible: false,
                inputValue: ''
            };
        },
        mounted: function(){
            if (this.selectMethod == "GET") {
                this.paramTypes = ["Params"];
            } else {
                this.paramTypes = ["Params", "Body: form data", "Body: x-www-form-urlencode"]
            }
        },
        methods: {
            selectSection(value) {             
                app.url = value;
            },
            paramTypeChanged(value) {
                console.log(value);
            },
            methodChanged(value) {
                if (value == "GET") {
                    app.paramTypes = ["Params"];
                    if (app.selectParamType != "GET") {
                        app.selectParamType = "";
                    }
                } else {
                    app.paramTypes = ["Params", "Body: form data", "Body: x-www-form-urlencode", "Body: raw"]
                }
            },
            handleAddRequest() {
                let param = { 
                    "urlId": result["urlInfo"]["id"],
                    "url": app.url, 
                    "desc": app.desc,
                    "content": app.content, 
                    "method":app.selectMethod,
                    "paramName": app.paramName,
                    "paramValues": app.paramValues,
                    "paramJson": app.paramJson,
                    "paramType": app.selectParamType,
                    "isNew": result["isNew"]
                }     

                axios.post($SCRIPT_ROOT + '/addRequest', param).then(function (response) {
                    if (response.data['code'] != 1) {
                        ELEMENT.Message({showClose: true, message: response.data['msg'], type: "error"});
                    } else {
                        ELEMENT.Message({showClose: true, message: '处理成功', type: "success"});
                    }
                });
            },
            handleClose(tag) {                
                app.paramValues.splice(app.paramValues.indexOf(tag), 1);
            },
            showInput() {
                app.inputVisible = true;
                app.$nextTick(_ => {
                    app.$refs.saveTagInput.$refs.input.focus();
                });
            },
            handleInputConfirm() {
                let inputValue = app.inputValue;                
                if (inputValue) {
                    app.paramValues.push(inputValue);
                    app.paramJson.push("");
                    app.selectParamValue = inputValue;
                }
                app.inputVisible = false;
                app.inputValue = '';
            },
            handleAddGroup() {
                console.log("add group");
                
            }
        }
    })

</script>

{% endblock %}